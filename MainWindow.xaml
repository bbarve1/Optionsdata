<Window x:Class="CVD.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:lvc="clr-namespace:LiveCharts.Wpf;assembly=LiveCharts.Wpf"
        Title="CVD Trend Scanner" Height="820" Width="1200" Background="#111">
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header Panel -->
        <DockPanel Margin="8" Grid.Row="0">
            <StackPanel Orientation="Horizontal" DockPanel.Dock="Left">
                <TextBlock Text="CVD Trend Scanner" FontSize="18" Foreground="White" VerticalAlignment="Center" Margin="0,0,12,0"/>
                <Button Content="Refresh" Width="90" Margin="0,0,6,0" Click="RefreshButton_Click"/>
                <Button Content="Load From DB" Width="120" Margin="0,0,6,0" Click="LoadCandidatesFromDb_Click"/>
                <Button Content="Connect WS" Width="100" Margin="0,0,6,0" Click="ConnectBtn_Click"/>
            </StackPanel>

            <StackPanel Orientation="Horizontal" DockPanel.Dock="Right">
                <TextBlock Text="DB:" Foreground="LightGray" VerticalAlignment="Center" Margin="6,0,4,0"/>
                <TextBlock x:Name="DbStatus" Text="Not connected" Foreground="Orange" VerticalAlignment="Center" Margin="0,0,12,0"/>
                <TextBlock Text="Conn:" Foreground="LightGray" VerticalAlignment="Center" Margin="6,0,4,0"/>
                <TextBlock x:Name="ConnectionStatus" Text="Disconnected" Foreground="Orange" VerticalAlignment="Center" Margin="0,0,12,0"/>
                <TextBlock Text="Status:" Foreground="LightGray" VerticalAlignment="Center" Margin="6,0,4,0"/>
                <TextBlock x:Name="StatusText" Text="Idle" Foreground="LightGray" VerticalAlignment="Center" Margin="0,0,12,0"/>
                <TextBlock x:Name="Timetext" Text="Idle" Foreground="LightGray" VerticalAlignment="Center" Margin="0,0,12,0"/>
            </StackPanel>
        </DockPanel>

        <Grid Grid.Row="1" Margin="8">
            <Grid.RowDefinitions>
                <RowDefinition Height="*"/>
                <RowDefinition Height="100"/>
            </Grid.RowDefinitions>

            <TabControl Grid.Row="0" Background="#222">
                <!-- Dashboard Tab -->
                <TabItem Header="Dashboard">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <!-- Filter Panel -->
                        <StackPanel Orientation="Horizontal" Margin="6" Grid.Row="0">
                            <TextBlock Text="Filter:" Foreground="LightGray" VerticalAlignment="Center"/>
                            <TextBox x:Name="FilterTextBox" Width="200" Margin="6,0,0,0" />
                            <Button Content="Apply" Margin="8,0,0,0" Click="ApplyFilter_Click"/>
                            <CheckBox x:Name="HideWeak" Content="Hide Weak" Margin="12,0,0,0" Foreground="LightGray"/>
                        </StackPanel>

                        <Grid Grid.Row="1">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="3*" />
                                <ColumnDefinition Width="2*" />
                            </Grid.ColumnDefinitions>

                            <!-- Summary DataGrid -->
                            <DataGrid x:Name="SummaryGrid" Grid.Column="0" Margin="6" AutoGenerateColumns="False" IsReadOnly="True"
                                      SelectionMode="Single" MouseDoubleClick="SummaryGrid_MouseDoubleClick"
                                      RowBackground="#1b1b1b" AlternatingRowBackground="#141414" Foreground="White" CanUserSortColumns="True">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="Symbol" Binding="{Binding StockName}" Width="80"/>
                                    <DataGridTextColumn Header="Spot %" Binding="{Binding SpotPrice, StringFormat=N2}" Width="80"/>
                                    <DataGridTextColumn Header="Future %" Binding="{Binding FuturePrice, StringFormat=N2}" Width="80"/>
                                    <DataGridTextColumn Header="VolumeStatus" Binding="{Binding VolumeStatus}" Width="100"/>
                                    <DataGridTextColumn Header="StockCVD" Binding="{Binding StockCVD}" Width="110"/>
                                    <DataGridTextColumn Header="RollingDelta" Binding="{Binding RollingDelta}" Width="100"/>
                                    <DataGridTextColumn Header="CVDStatus" Binding="{Binding CVDStatus}" Width="80"/>
                                    <DataGridTextColumn Header="OpenHL" Binding="{Binding OpenHighLow}" Width="80"/>
                                    <DataGridTextColumn Header="VWAP" Binding="{Binding VWAPStatus}" Width="80"/>
                                    <DataGridTextColumn Header="TotalScore" Binding="{Binding TotalScore}" Width="80"/>
                                    <DataGridTextColumn Header="Signal" Binding="{Binding SignalStrength}" Width="90"/>
                                </DataGrid.Columns>
                            </DataGrid>

                            <!-- Details / Minute bars -->
                            <DataGrid x:Name="DetailGrid" Grid.Column="1" Margin="6" AutoGenerateColumns="False" IsReadOnly="True"
                                      RowBackground="#1b1b1b" AlternatingRowBackground="#141414" Foreground="White">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="Time" Binding="{Binding Time, StringFormat=HH:mm}" Width="70"/>
                                    <DataGridTextColumn Header="O" Binding="{Binding Open, StringFormat=N2}" Width="70"/>
                                    <DataGridTextColumn Header="H" Binding="{Binding High, StringFormat=N2}" Width="70"/>
                                    <DataGridTextColumn Header="L" Binding="{Binding Low, StringFormat=N2}" Width="70"/>
                                    <DataGridTextColumn Header="C" Binding="{Binding Close, StringFormat=N2}" Width="70"/>
                                    <DataGridTextColumn Header="Vol" Binding="{Binding Volume}" Width="90"/>
                                    <DataGridTextColumn Header="Delta" Binding="{Binding Delta}" Width="90"/>
                                    <DataGridTextColumn Header="RollingCVD" Binding="{Binding RollingCvd}" Width="110"/>
                                    <DataGridTextColumn Header="OI" Binding="{Binding OI}" Width="90"/>
                                </DataGrid.Columns>
                            </DataGrid>
                        </Grid>
                    </Grid>
                </TabItem>

                <!-- Chart Tab -->
                <TabItem Header="Chart">
                    <Grid Background="#1E1E1E">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="0.9*"/>
                        </Grid.RowDefinitions>

                        <StackPanel Orientation="Horizontal" Margin="10" Grid.Row="0">
                            <ComboBox x:Name="SymbolCombo" Width="150" Margin="5"/>
                            <ComboBox x:Name="TimeframeCombo" Width="80" Margin="5">
                                <ComboBoxItem Content="1"/>
                                <ComboBoxItem Content="5"/>
                                <ComboBoxItem Content="15"/>
                            </ComboBox>
                            <DatePicker x:Name="DatePickerBox" Width="150" Margin="5"/>
                            <Button Content="Load Chart" Width="120" Margin="5" Click="LoadChart_Click"/>
                        </StackPanel>

                        <!-- Price Chart with ScrollViewer -->
                        <ScrollViewer Grid.Row="1" Margin="10" HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto">
                            <lvc:CartesianChart x:Name="PriceChart" MinWidth="800" Height="300"/>
                        </ScrollViewer>

                        <!-- CVD Chart with ScrollViewer -->
                        <ScrollViewer Grid.Row="2" Margin="10" HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto">
                            <lvc:CartesianChart x:Name="CvdChart" MinWidth="800" Height="200"/>
                        </ScrollViewer>
                    </Grid>
                </TabItem>
            </TabControl>

            <!-- Output log area -->
            <TextBox x:Name="OutputTextBox" Grid.Row="1" Margin="6" Foreground="LightGray" Background="#080808" IsReadOnly="True" VerticalScrollBarVisibility="Auto" TextWrapping="Wrap"/>
        </Grid>

        <!-- Database Insertion Status Panel -->
        <Border Grid.Row="2" Background="#1a1a1a" BorderBrush="#333" BorderThickness="1" Margin="8,4,8,8">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <StackPanel Orientation="Horizontal" Grid.Row="0" Margin="6,4,6,2">
                    <TextBlock Text="📊 Database Insertion Status" Foreground="LightGreen" FontWeight="Bold" VerticalAlignment="Center"/>
                    <TextBlock x:Name="InsertionStatus" Text="Idle" Foreground="Yellow" VerticalAlignment="Center" Margin="12,0,0,0"/>
                    <TextBlock Text="| Batches:" Foreground="LightGray" VerticalAlignment="Center" Margin="12,0,2,0"/>
                    <TextBlock x:Name="BatchCount" Text="0" Foreground="White" VerticalAlignment="Center" FontWeight="Bold"/>
                    <TextBlock Text="| Ticks:" Foreground="LightGray" VerticalAlignment="Center" Margin="8,0,2,0"/>
                    <TextBlock x:Name="TickCount" Text="0" Foreground="White" VerticalAlignment="Center" FontWeight="Bold"/>
                    <TextBlock Text="| Success:" Foreground="LightGray" VerticalAlignment="Center" Margin="8,0,2,0"/>
                    <TextBlock x:Name="SuccessCount" Text="0" Foreground="LightGreen" VerticalAlignment="Center" FontWeight="Bold"/>
                    <TextBlock Text="| Failed:" Foreground="LightGray" VerticalAlignment="Center" Margin="8,0,2,0"/>
                    <TextBlock x:Name="FailedCount" Text="0" Foreground="Red" VerticalAlignment="Center" FontWeight="Bold"/>
                    <TextBlock Text="| Queue:" Foreground="LightGray" VerticalAlignment="Center" Margin="8,0,2,0"/>
                    <TextBlock x:Name="QueueSize" Text="0" Foreground="Orange" VerticalAlignment="Center" FontWeight="Bold"/>
                    <TextBlock Text="| Active DB:" Foreground="LightGray" VerticalAlignment="Center" Margin="8,0,2,0"/>
                    <TextBlock x:Name="ActiveDbCount" Text="0" Foreground="Cyan" VerticalAlignment="Center" FontWeight="Bold"/>
                </StackPanel>

                <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" MaxHeight="80" Margin="6,2,6,4">
                    <TextBlock x:Name="InsertionLog" Text="Waiting for data..." Foreground="LightGray" TextWrapping="Wrap"/>
                </ScrollViewer>
            </Grid>
        </Border>
    </Grid>
</Window>